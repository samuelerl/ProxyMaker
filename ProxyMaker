#!/usr/bin/env bash
# ProxyMaker: manage a local SSH tunnel to a remote kubectl proxy.

set -euo pipefail

LOCAL_PORT=${LOCAL_PORT:-8080}
REMOTE_PORT=${REMOTE_PORT:-8888}

usage() {
    cat <<USAGE
Usage: $(basename "$0") <remote_host>

Creates a kubectl API proxy on <remote_host> and forwards it locally.

Environment variables:
  LOCAL_PORT   Local port to bind the SSH tunnel (default: ${LOCAL_PORT}).
  REMOTE_PORT  Remote kubectl proxy port (default: ${REMOTE_PORT}).

Dependencies: ssh, kubectl on the remote host, and permission to run them.
USAGE
}

log() {
    printf '[%s] %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$*"
}

if [[ $# -lt 1 ]]; then
    usage
    exit 1
fi

server=$1

tunnel_pattern="ssh -L ${LOCAL_PORT}:127.0.0.1:${REMOTE_PORT}"

if pids=$(pgrep -f "$tunnel_pattern" 2>/dev/null); then
    log "Stopping existing local tunnel(s): $pids"
    kill -9 $pids
fi

remote_pids=$(ssh "$server" "pgrep -f 'kubectl proxy --port=${REMOTE_PORT} --disable-filter=true'" 2>/dev/null || true)
if [[ -n "$remote_pids" ]]; then
    log "Stopping remote kubectl proxy on ${server}: $remote_pids"
    ssh "$server" "kill -9 $remote_pids"
fi

log "Starting kubectl proxy on ${server} (port ${REMOTE_PORT})"
ssh "$server" "nohup kubectl proxy --port=${REMOTE_PORT} --disable-filter=true >/dev/null 2>&1 &" -q

log "Starting SSH tunnel to ${server} (local ${LOCAL_PORT} -> remote ${REMOTE_PORT})"
ssh -f -L "${LOCAL_PORT}:127.0.0.1:${REMOTE_PORT}" "$server" -q -N

log "Tunnel ready: http://127.0.0.1:${LOCAL_PORT}"
